services:
    postgres:
        container_name: postgres
        image: postgres:16.8-alpine
        restart: always
        ports:
            - 5432:5432
        volumes:
            - postgres:/var/lib/postgresql/data
        environment:
            POSTGRES_DB: ${PGDATABASE}
            POSTGRES_USER: ${PGUSER}
            POSTGRES_PASSWORD: ${PGPASSWORD}
    pnpm:
        container_name: pnpm
        image: gplane/pnpm:10.6.5-alpine
        restart: always
        working_dir: /app
        volumes:
            - ./package.json:/app/package.json:ro
            - ./pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
            - ./.env:/app/.env:ro
            - ./esbuild.config.js:/app/esbuild.config.js:ro
            - ./run.js:/app/run.js:ro
            - ./src:/app/src:ro
            - ./assets:/app/assets
            - ./public:/app/public
        command: sh -c "pnpm i && pnpm dev"
    composer:
        container_name: composer
        image: composer:2.8.7
        restart: on-failure
        working_dir: /app
        volumes:
            - ./composer.json:/app/composer.json:ro
            - ./composer.lock:/app/composer.lock:ro
            - ./vendor:/app/vendor
        command: sh -c "composer i"
    php:
        container_name: php
        restart: always
        build:
            context: .
            dockerfile: php/Dockerfile
        working_dir: /app
        volumes:
            - ./public:/app/public:ro
            - ./avatar:/app/avatar:ro
            - ./src:/app/src:ro
            - ./svg:/app/svg:ro
            - ./vendor:/app/vendor:ro
            - avatars:/app/avatars
            - ./.env:/app/.env:ro
            - ./php/php.ini:/app/php.ini:ro
            - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
        depends_on:
            - postgres
            - pnpm
            - composer
    nginx:
        container_name: nginx
        restart: always
        build:
            context: .
            dockerfile: nginx/Dockerfile
        volumes:
            - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
            - ./htpasswd/htpasswd.sh:/htpasswd.sh:ro
            - ./htpasswd/.htpasswd:/etc/nginx/.htpasswd
        depends_on:
            - php
    varnish:
        container_name: varnish
        image: varnish:7.7.0-alpine
        restart: always
        ports:
            - 63342:80
        volumes:
            - ./varnish/default.vcl:/etc/varnish/default.vcl:ro
        depends_on:
            - php
    prometheus:
        container_name: prometheus
        image: prom/prometheus:v3.4.0
        restart: always
        volumes:
            - ./prometheus/prometheus.yaml:/etc/prometheus/prometheus.yml:ro
        depends_on:
            - php
    grafana:
        container_name: grafana
        image: grafana/grafana:11.3.5
        restart: always
        volumes:
            - ./grafana/provisioning.yaml:/etc/grafana/provisioning/datasources/datasources.yaml
        depends_on:
            - nginx
            - prometheus
        environment:
            GF_SECURITY_DISABLE_INITIAL_ADMIN_CREATION: ${INITIALADMINDISABLED}
            GF_AUTH_PROXY_ENABLED: ${AUTHPROXYENABLED}
            GF_AUTH_PROXY_HEADER_NAME: ${AUTHPROXYHEADER}
            GF_USERS_AUTO_ASSIGN_ORG_ROLE: ${ORGROLE}
            GF_SERVER_ROOT_URL: ${ROOTURL}
    cadvisor:
        container_name: cadvisor
        image: gcr.io/cadvisor/cadvisor:v0.52.0
        restart: always
        volumes:
            - /:/rootfs:ro
            - /var/run:/var/run:ro
            - /sys:/sys:ro
            - /var/lib/docker:/var/lib/docker:ro
        depends_on:
            - grafana
volumes:
    postgres:
        name: postgres
    avatars:
        name: avatars
